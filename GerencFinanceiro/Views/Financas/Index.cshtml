@model IEnumerable<GerencFinanceiro.Models.Financas>
@{
    ViewData["Title"] = "Gerenciador de Finanças Pessoal";
}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <h2>Minhas Finanças</h2>
    <br />
    <div>
        <div style="float:left">
            <button class="btn btn-primary" onclick="AddEditDespesa(0)">Adicionar Despesa</button>
            <button class="btn btn-primary" onclick="AddEditReceita(0)">Adicionar Receita</button>
            <button class="btn btn-success" onclick="ReportDespesas()">Relatório Despesas</button>
            <button class="btn btn-success" onclick="ReportReceitas()">Relatório Receitas</button>
            <a class="btn btn-info" href="@Url.Action("Dashboard", "Financas")">Ir para o Dashboard</a> <!-- Novo botão para o Dashboard -->
        </div>

        <div style="float:right; width:40%;">
            <form asp-controller="Despesa" asp-action="Index" method="get" class="form-group">
                <div class="col-sm-6">
                    <input class="form-control" type="text" name="criterio" placeholder="Procurar" aria-label="Procurar despesa">
                </div>
                <button type="submit" class="btn btn-default btn-info">Filtrar</button>
            </form>
        </div>
    </div>
    <br />
    <br />
    <table class="table">
        <thead>
            <tr>
                <th>@Html.DisplayNameFor(model => model.First().ItemId)</th>
                <th>@Html.DisplayNameFor(model => model.First().ItemNome)</th>
                <th>@Html.DisplayNameFor(model => model.First().Valor)</th>
                <th>@Html.DisplayNameFor(model => model.First().Date)</th>
                <th>@Html.DisplayNameFor(model => model.First().Categoria)</th>
                <th>Tipo Finança</th>
                <th>Ações</th> <!-- Mantenha esta coluna como está -->
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@Html.DisplayFor(modelItem => item.ItemId)</td>
                    <td>@Html.DisplayFor(modelItem => item.ItemNome)</td>
                    <td>@Html.DisplayFor(modelItem => item.Valor)</td>
                    <td>@Html.DisplayFor(modelItem => item.Date)</td>
                    <td>@Html.DisplayFor(modelItem => item.Categoria)</td>
                    <td>
                        @if (item.IsReceita)
                        {
                            <span class="text-success">Receita</span>
                        }
                        else
                        {
                            <span class="text-danger">Despesa</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-default" onclick="AddEditFinanca(@item.ItemId)">Editar</button>
                        <button class="btn btn-danger" onclick="DeleteFinanca(@item.ItemId)">Deletar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Modal para adicionar/editar despesa -->
    <div class="modal fade" id="despesaFormModel" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body" id="despesaFormModelDiv">
                    <!-- O formulário de despesa será carregado aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/editar receita -->
    <div class="modal fade" id="receitaFormModel" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body" id="receitaFormModelDiv">
                    <!-- O formulário de receita será carregado aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para o relatório -->
    <div class="modal fade" id="financaFormModel" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Relatório de Despesas</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" id="financaFormModelDiv">
                    <!-- O conteúdo do relatório será carregado aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        var AddEditDespesa = function (itemId) {
            var url = "/Financas/AddEditDespesa?itemId=" + itemId;
            if (itemId > 0) $('#title').html("Editar Despesa");
            $("#despesaFormModelDiv").load(url, function () {
                $("#despesaFormModel").modal("show");
            });
        }

        var AddEditReceita = function (itemId) {
            var url = "/Financas/AddEditReceita?itemId=" + itemId;
            if (itemId > 0) $('#title').html("Editar Receita");
            $("#receitaFormModelDiv").load(url, function () {
                $("#receitaFormModel").modal("show");
            });
        }

        var DeleteFinanca = function (itemId) {
            if (confirm("Tem certeza que deseja excluir essa financa?")) {
                $.ajax({
                    type: "POST",
                    url: "/Financas/Delete/" + itemId,
                    success: function (response) {
                        alert("Financa excluída com sucesso!");
                        window.location.href = "/Financas/Index";
                    },
                    error: function (errormessage) {
                        alert(errormessage.responseText);
                    }
                });
            }
        }

        // Submissão do formulário de despesa
        $('body').on('click', "#btnSubmit", function (event) {
            event.preventDefault();

            var activeForm = "";
            if ($("#despesaFormModel").is(":visible")) {
                activeForm = "#despesaForm";
            } else if ($("#receitaFormModel").is(":visible")) {
                activeForm = "#receitaForm";
            }

            var myformdata = $(activeForm).serialize();
            console.log("Dados do formulário:", myformdata);

            $.ajax({
                type: "POST",
                url: "/Financas/Create",
                data: myformdata,
                success: function (response) {
                    $("#financaFormModel").modal("hide");
                    window.location.href = "/Financas/Index";
                },
                error: function (errormessage) {
                    alert("Erro ao salvar despesa: " + errormessage.responseText);
                }
            });
        });

        var ReportDespesas = function () {
            var period = prompt("Digite o período do relatório (7 para semanal, 30 para mensal, 180 para semestral):");

            if (!period) {
                alert("Período inválido!");
                return;
            }

            $.ajax({
                type: "GET",
                url: "/Financas/GetFinancaPorPeriodo?period=" + period,
                success: function (response) {
                    var reportHtml = "<h4>Relatório de Despesas</h4><table class='table'><thead><tr><th>Categoria</th><th>Valor Total</th></tr></thead><tbody>";

                    for (var key in response) {
                        if (response.hasOwnProperty(key)) {
                            reportHtml += "<tr><td>" + key + "</td><td>" + response[key].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) + "</td></tr>";
                        }
                    }
                    console.log(response);

                    reportHtml += "</tbody></table>";

                    $("#financaFormModelDiv").html(reportHtml);
                    $("#financaFormModel").modal("show");
                },
                error: function (errormessage) {
                    alert("Erro ao gerar relatório: " + errormessage.responseText);
                }
            });
        };

        var ReportReceitas = function () {
            var period = prompt("Digite o período do relatório (7 para semanal, 30 para mensal, 180 para semestral):");

            if (!period) {
                alert("Período inválido!");
                return;
            }

            $.ajax({
                type: "GET",
                url: "/Financas/GetFinancaPorPeriodo?period=" + period,
                success: function (response) {
                    console.log("Resposta do servidor:", response); // Para depuração

                    if (!response.Receitas || typeof response.Receitas !== 'object' || Object.keys(response.Receitas).length === 0) {
                        alert("Nenhuma receita encontrada.");
                        return;
                    }

                    var reportHtml = "<h4>Relatório de Receitas</h4><table class='table'><thead><tr><th>Categoria</th><th>Valor Total</th></tr></thead><tbody>";

                    // Usar Object.entries para iterar sobre as receitas
                    Object.entries(response.Receitas).forEach(function ([categoria, total]) {
                        reportHtml += "<tr><td>" + categoria + "</td><td>" + total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) + "</td></tr>";
                    });

                    reportHtml += "</tbody></table>";
                    $("#financaFormModelDiv").html(reportHtml);
                    $("#financaFormModel").modal("show");
                },
                error: function (errormessage) {
                    alert("Erro ao gerar relatório: " + errormessage.responseText);
                }
            });
        };




    </script>
</body>
</html>